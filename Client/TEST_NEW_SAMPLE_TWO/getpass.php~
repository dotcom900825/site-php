<?php
require_once(dirname(__FILE__)."/../../lib/class/DebugLog.php");
require_once(dirname(__FILE__)."/../../lib/class/DataInterface.php");
// input validation check
if (strlen($_POST['first_name']) < 2) {
    header("Location: index.php?message=Sorry, please enter a valid first name");
    exit();
}
if (strlen($_POST['last_name']) < 2) {
    header("Location: index.php?message=Sorry, please enter a valid last name");
    exit();
}
// email address validation

if (!filter_var($_POST['user_email'], FILTER_VALIDATE_EMAIL)) {
    header("Location: index.php?message=Sorry, please enter a valid email");
    exit();
}

//**********************************************************************************
// password check

if ($_POST['password'] != "aaa") {
    header("Location: index.php?message=Oops! Password did not match! Try again.");
    exit();
}

//######################## Modify for each card ##################################
// absolute path to pass files
$keyPath = dirname(__file__) . "/../../Client/TEST_NEW_SAMPLE/pass";

// absolute path to pass source files
$sourcePath = $keyPath . "/source";

// password for the key file
$keyPassword = "ucsdcssa95536";

// passTypeID registered on Apple Developer Portal
$passTypeID = "pass.com.ipassstore.ucsdcssa";
$cardID = 2;
//################################################################################


// store user input
$firstName = $_POST['first_name'];
$lastName = $_POST['last_name'];
$userEmail = $_POST['user_email'];


if (!DataInterface::ifRegistered($userEmail, $cardID)) {
    //no pass was found
    header("Location: index.php?message=Sorry, this email address has already been registered.");
    exit();
}

require_once (dirname(__file__) . "/../../lib/class/AmazonSES.php");
require_once (dirname(__file__) . "/../../lib/class/StorePass.php");


/*****************************error check**************************
$EmailFrom = "noreply@ipassstore.com";
$EmailTo = "xilldian@gmail.com";
$subject = "Check Point 1 Reached"; 

// prepare email body text
$body = "Check Point 1 Reached";

// send email 
$success = mail($EmailTo, $subject, $body, "From: <$EmailFrom>");
//******************************************************************/

//generate a new pass instance
$card = new StorePass($keyPath, $sourcePath, $keyPassword, $passTypeID, $cardID);
$card = $card->createPassWithUniqueSerialNr($error, $firstName, $lastName, $userEmail);

if ($card != null) {
    //************************************************************************************
    $subject = "Your UCSD CSSA membership card has arrived";
    $message = $firstName .
        ", Thank you for participating! Now you can use this discount card at stores listed in the back of this card. Congratulations again, now you are a true CSSA fan and loyal member, enjoy your free membership discount card. :)";

    //************************************************************************************
    //send it over to the user
    $card->outputPassBundleAsEmailAttachmentAmazonSES($userEmail, $subject, $message);

    //show thank you message
    header("Location: index.php?message=Congratulations! Your membership card has been sent to " .
        $_POST['user_email']);

} else {
    //there was an error
    die("Error: " . $error);
}

?>